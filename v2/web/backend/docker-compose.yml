services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - mongo_data:/data/db

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - mongo
    environment:
      PORT: 9050
      MONGO_HOST: mongo
      MONGO_PORT: 27017
      MONGO_DB: maimai_web
      MONGO_USER: root
      MONGO_PASSWORD: example
      MONGO_AUTH_SOURCE: admin
      MUSIC_DATA_URL: https://www.diving-fish.com/api/maimaidxprober/music_data
      MUSIC_SYNC_CRON: "0 */6 * * *"
      AUTH_JWT_SECRET: change-me-in-production
    volumes:
      - ./covers:/app/covers

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./covers:/covers:ro

volumes:
  mongo_data:
